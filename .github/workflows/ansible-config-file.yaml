name: Generate ansible.cfg

on:
  workflow_dispatch:

jobs:
  generate-ansible-cfg:
    runs-on: [ self-hosted ]

    steps:


      - name: Generate ansible.cfg
        run: |
          sudo -u user20 bash -c 'cat > /home/user20/ansible/ansible.cfg' << 'EOF'
          [defaults]
          inventory      = /home/user20/ansible/inventory.yaml
          roles_path    = /home/user20/ansible/roles
          host_key_checking = False
          remote_user = user20
          private_key_file = /home/user20/.ssh/id_rsa
          log_path = /home/user20/ansible/ansible.log
          forks = 5
          gathering = smart
          fact_caching = jsonfile
          fact_caching_connection = /home/user20/ansible/facts_cache
          

          [privilege_escalation]
          become = True
          become_method = sudo
          become_user = root
          become_ask_pass = False

          [ssh_connection]
          ssh_args = -o ControlMaster=auto -o ControlPersist=60s -o ConnectTimeout=10
          control_path = /home/user20/.ssh/id_rsa-%%r@%%h:%%p
          EOF
          

      - name: Set proper permissions
        run: |
          sudo chown user20:user20 /home/user20/ansible/ansible.cfg
          sudo chmod 644 /home/user20/ansible/ansible.cfg

      - name: Verify configuration
        run: |
          echo "Ansible configuration:"
          sudo -u user20 ls -la /home/user20/ansible/ansible.cfg
          echo -e "\nContents:"
          sudo -u user20 cat /home/user20/ansible/ansible.cfg
